# 套餐商品新增功能 - 產品需求文件 (PRD)

## 1. 引言/概述

本功能旨在擴展現有的 `createMenuItem` MCP tool，增加套餐商品（combo item）的新增能力。目前系統僅支援單品（item）的新增，透過此功能擴展，使用者將能夠新增包含多個分類和選項的套餐商品，每個分類可包含多個商品選項，並支援自訂價格設定。

此功能主要解決餐廳需要建立套餐商品的需求，如「午餐套餐」包含主餐、飲料、配菜等不同分類，每個分類可選擇不同的商品組合。

## 2. 目標

- **主要目標 1**：擴展現有 MCP tool 支援套餐商品新增，保持 API 一致性
- **主要目標 2**：提供完整的套餐分類和選項管理功能
- **主要目標 3**：保持與現有單品新增功能相同的使用體驗和錯誤處理機制
- **效能目標**：單次 API 呼叫完成完整套餐建立，回應時間不超過 3 秒

## 3. 功能需求

### 3.1 核心功能

1. **套餐商品基本資訊**
   - 系統必須支援新增 type 為 "combo" 的商品
   - 使用者應能夠設定套餐名稱、價格、分類 UUID 等基本資訊
   - 系統必須驗證套餐商品的必填欄位（name, price, menuItemCategoryUuid, type）

2. **套餐分類管理**
   - 系統必須支援新建套餐分類（comboItemCategories）
   - 使用者應能夠為每個套餐分類設定名稱
   - 系統應提供預設的選擇數量設定（minimumSelection: 1, maximumSelection: 1）
   - 當未指定選擇數量時，系統必須使用預設值

3. **套餐選項管理**
   - 系統必須支援在每個套餐分類下新增商品選項（comboMenuItems）
   - 使用者應能夠指定選項的 menuItemUuid
   - 系統必須支援為套餐選項設定自訂價格（非必填）
   - 當未指定價格時，系統應使用原商品價格

4. **資料驗證**
   - 系統必須驗證套餐至少包含一個分類
   - 系統必須驗證每個分類至少包含一個商品選項
   - 系統必須驗證所有 UUID 格式的正確性
   - 系統必須驗證價格為非負數（可為 0）

### 3.2 輔助功能

1. **錯誤處理擴展**
   - 當套餐分類缺少必要資訊時，系統必須提供具體的錯誤訊息
   - 當套餐選項設定錯誤時，系統必須指出具體的錯誤位置
   - 系統應保持與現有錯誤處理機制的一致性

2. **回應格式化**
   - 當 type 為 "combo" 時，系統必須顯示套餐結構詳細資訊
   - 當 type 為 "item" 時，系統必須保持現有的回應格式
   - 系統應清楚顯示每個套餐分類和其包含的選項

## 4. 非目標 (超出範圍)

- **非目標 1**：不支援複選同一個套餐分類（allowRepeatableSelection 固定為 false）
- **非目標 2**：不驗證 menuItemUuid 在系統中的存在性
- **非目標 3**：不支援套餐的庫存管理功能
- **非目標 4**：不支援套餐的圖片和標籤設定（僅支援基本商品資訊）
- **非目標 5**：不提供套餐預覽或驗證功能

## 5. 設計考量

### 5.1 API 設計

- **輸入格式**：採用嵌套結構，直接對應 GraphQL schema 的 `comboItemCategories` 格式
- **向後相容**：現有的單品新增功能必須完全保持不變
- **參數驗證**：擴展現有的驗證邏輯，增加套餐特有的驗證規則

### 5.2 使用者體驗

- **統一性**：保持與現有 MCP tool 相同的使用方式和回應格式
- **清晰性**：套餐建立成功後，明確顯示套餐結構和各分類資訊
- **錯誤提示**：提供具體且可操作的錯誤訊息

### 5.3 資料結構

```typescript
// 輸入參數結構
{
  name: string;
  price: number;
  menuItemCategoryUuid: string;
  type: "combo";
  comboItemCategories?: [
    {
      name: string;
      minimumSelection?: number; // 預設 1
      maximumSelection?: number; // 預設 1
      comboMenuItems: [
        {
          menuItemUuid: string;
          price?: string; // 選填，自訂價格
        }
      ]
    }
  ]
}
```

## 6. 技術考量

### 6.1 技術架構

- **GraphQL Mutation**：擴展現有的 `createMenuItemMutation` 包含 `comboItemCategories` 欄位
- **類型安全**：使用 TypeScript 確保參數類型的正確性
- **錯誤處理**：沿用現有的 try-catch 和錯誤格式化機制

### 6.2 與現有系統的整合

- **MCP Tool 介面**：保持現有的 `inputSchema` 和 `handler` 結構
- **GraphQL 客戶端**：使用現有的 `createGraphQLClient()`
- **類型定義**：使用 `generated.ts` 中的類型定義

### 6.3 效能要求

- **單次呼叫**：所有套餐資料在一次 GraphQL mutation 中完成建立
- **資料量限制**：建議單個套餐不超過 10 個分類，每個分類不超過 20 個選項

### 6.4 資安考量

- **輸入驗證**：對所有使用者輸入進行嚴格驗證
- **SQL 注入防護**：透過 GraphQL 參數化查詢確保安全性

## 7. 成功指標

### 7.1 量化指標

- **功能完整性**：100% 支援 `CreateMenuItemPayload` 中的 `comboItemCategories` 欄位
- **向後相容性**：現有單品新增功能 0% 異動
- **回應時間**：套餐建立回應時間 < 3 秒
- **錯誤處理覆蓋率**：套餐相關錯誤情境覆蓋率 > 90%

### 7.2 質化指標

- **使用體驗一致性**：套餐和單品新增的操作流程保持一致
- **錯誤訊息清晰度**：使用者能夠根據錯誤訊息快速定位和修正問題
- **程式碼可維護性**：新增功能不影響現有程式碼結構

## 8. 實作範圍

### 8.1 需要修改的檔案

1. **`src/api/gql/createMenuItemMutation.ts`**
   - 在 GraphQL mutation 中加入 `comboItemCategories` 欄位

2. **`src/tools/createMenuItem.ts`**
   - 擴展 `CreateMenuItemArgs` 介面
   - 增加套餐參數驗證邏輯
   - 實作套餐回應格式化函數
   - 在 `inputSchema` 中增加套餐相關欄位

### 8.2 新增的功能模組

1. **套餐參數驗證函數**
   - 驗證套餐分類結構
   - 驗證商品選項格式
2. **套餐回應格式化函數**
   - 根據商品類型（item/combo）選擇不同的格式化邏輯
   - 顯示套餐結構詳細資訊

## 9. 開放問題

- [ ] **價格顯示格式**：套餐選項的自訂價格是否需要特殊的格式化顯示？好啊
- [ ] **分類排序**：套餐分類是否需要支援自訂排序？先不支援
- [ ] **選項排序**：套餐選項是否需要支援自訂排序？先不支援
- [ ] **國際化**：錯誤訊息和回應格式是否需要支援多語言？不需要

## 10. 驗收標準

### 10.1 功能測試

- [ ] 能夠成功新增包含多個分類的套餐商品
- [ ] 能夠為套餐選項設定自訂價格
- [ ] 套餐建立後回應包含完整的結構資訊
- [ ] 現有單品新增功能完全不受影響

### 10.2 錯誤處理測試

- [ ] 缺少必填套餐分類時顯示適當錯誤
- [ ] 無效的商品選項 UUID 格式時顯示適當錯誤
- [ ] 價格格式錯誤時顯示適當錯誤
- [ ] 網路錯誤時保持現有的錯誤處理機制

### 10.3 效能測試

- [ ] 包含 5 個分類、每分類 10 個選項的套餐建立時間 < 3 秒
- [ ] 同時進行單品和套餐新增時無效能衝突

---

**文件版本：** 1.0  
**建立日期：** 2024-12-19  
**負責人：** 前端開發團隊  
**審核狀態：** 待審核
