# importMenuItemToOnlineRestaurant - 產品需求文件 (PRD)

## 1. 引言/概述

本功能為 iChef MCP（Model Control Protocol）工具包的新增功能，名為 `importMenuItemToOnlineRestaurant`。此功能主要用於將 iChef 內部菜單系統中的商品批量匯入到外帶外送平台的指定分類中，實現內部菜單與外送平台商品的快速同步上架。

該功能解決了餐廳需要將內部菜單商品逐一手動上架到外送平台的問題，提供批量處理能力，大幅提升運營效率。

## 2. 目標

- 目標 1：提供批量匯入功能，允許一次性將多個 iChef 菜單商品匯入到外送平台指定分類
- 目標 2：實現智能過濾機制，僅允許啟用狀態的商品進行匯入操作
- 目標 3：提供友善的使用者體驗，包含匯入前確認和詳細的執行結果回饋
- 目標 4：建立完善的錯誤處理機制，確保操作安全性和可靠性

## 3. 功能需求

### 3.1 核心功能

1. **批量商品匯入**
   - 系統必須支援一次性匯入多個商品到外送平台分類
   - 不限制單次匯入的商品數量
   - 使用 GraphQL mutation `onlineRestaurantMenuItemImportMutation` 執行匯入操作

2. **商品狀態驗證**
   - 系統必須在匯入前檢查每個商品的啟用狀態
   - 僅允許已啟用（enabled: true）的商品進行匯入
   - 停用商品將被自動排除並在結果中標示

3. **重複商品處理**
   - 當商品已存在於目標分類時，系統應跳過該商品
   - 在執行結果中顯示跳過的重複商品清單和警告訊息
   - 不因重複商品而中斷整個匯入流程

4. **匯入前確認機制**
   - 系統必須在執行實際匯入前顯示即將匯入的商品清單
   - 包含商品名稱、UUID、價格、狀態等關鍵資訊
   - 使用表格格式呈現商品資訊供使用者確認

### 3.2 輔助功能

1. **參數驗證**
   - 驗證 categoryUuid 為有效的 UUID 格式
   - 驗證 ichefMenuItemUuids 陣列格式和內容有效性
   - 提供詳細的參數錯誤訊息

2. **執行結果回饋**
   - 使用表格格式顯示匯入結果
   - 分別統計成功匯入、跳過重複、停用排除的商品數量
   - 提供每個商品的具體處理狀態

3. **錯誤處理**
   - 遵循現有專案的錯誤處理模式
   - 針對不同錯誤類型提供相應的中文錯誤訊息
   - 包含網路錯誤、認證錯誤、權限錯誤、業務邏輯錯誤等

## 4. 非目標 (超出範圍)

- 非目標 1：不提供商品資訊的修改或更新功能（僅限匯入現有商品）
- 非目標 2：不支援自動建立外送平台分類功能
- 非目標 3：不提供商品圖片或詳細描述的同步處理
- 非目標 4：不支援排程或自動化匯入功能
- 非目標 5：不提供匯入進度的即時顯示（批量操作一次性完成）

## 5. 設計考量

### 5.1 UI/UX 需求

- **一致性設計**：遵循現有 MCP 工具的介面風格和回應格式
- **表格化呈現**：使用結構化表格格式顯示商品清單和執行結果
- **Emoji 視覺標示**：使用 emoji 圖示增強視覺識別（✅ 成功、❌ 失敗、⚠️ 警告等）
- **分步驟操作**：匯入前確認 → 使用者確認 → 執行匯入 → 結果展示

### 5.2 訊息格式化規範

- **確認訊息**：清楚列出即將匯入的商品資訊，包含關鍵欄位
- **結果訊息**：使用表格格式統計和展示各類處理結果
- **錯誤訊息**：提供具體的錯誤原因和建議解決方案

### 5.3 操作流程設計

1. 使用者提供參數（categoryUuid 和 ichefMenuItemUuids）
2. 系統驗證參數格式和有效性
3. 系統檢查每個商品的狀態並過濾停用商品
4. 顯示即將匯入的商品清單供使用者確認
5. 使用者確認後執行批量匯入操作
6. 顯示詳細的執行結果統計

## 6. 技術考量

### 6.1 技術架構

- **GraphQL Integration**：使用現有的 GraphQL 客戶端和 mutation 機制
- **型別安全**：遵循 TypeScript 嚴格型別定義
- **模組化設計**：參考 createMenuItem.ts 的架構模式

### 6.2 API 整合

- **Mutation**：`onlineRestaurantMenuItemImportMutation`
- **參數**：
  - `categoryUuid: UUID!` - 外送分類的唯一識別碼
  - `ichefMenuItemUuids: [UUID]!` - iChef 菜單商品 UUID 陣列
- **回應格式**：返回匯入成功的商品 UUID 清單

### 6.3 資料驗證

- **UUID 格式驗證**：使用正規表達式驗證 UUID 格式正確性
- **陣列長度檢查**：確保商品 UUID 陣列不為空
- **商品狀態檢查**：在匯入前驗證商品啟用狀態

### 6.4 錯誤處理機制

prdImportMenuItemToOnlineRestaurant

遵循專案既有的錯誤分類和處理方式：

- **GRAPHQL_ENDPOINT 錯誤**：GraphQL 端點未設定
- **GRAPHQL_TOKEN 錯誤**：認證 Token 問題
- **Network 錯誤**：網路連線問題
- **401 Unauthorized**：認證失敗
- **403 Forbidden**：權限不足
- **400 Bad Request**：請求參數錯誤
- **UNAUTHENTICATED**：身份驗證失敗
- **PERMISSION_DENIED**：權限被拒絕
- **NOT_FOUND**：資源不存在
- **INVALID_ARGUMENT**：參數格式錯誤

### 6.5 與現有系統的整合

- **一致的工具介面**：實作 IChefMcpTool 介面
- **統一的回應格式**：使用 McpToolResponse 格式
- **相容的錯誤處理**：遵循現有的錯誤處理模式
- **相同的 GraphQL 客戶端**：使用 createGraphQLClient() 函數

## 7. 成功指標

### 7.1 量化指標

- **功能正確性**：100% 的有效商品成功匯入到指定分類
- **錯誤處理覆蓋率**：涵蓋所有可能的錯誤情境並提供適當處理
- **使用者體驗**：匯入前確認機制使用率達 100%

### 7.2 質化指標

- **使用者回饋**：操作流程清晰易懂，錯誤訊息具有指導性
- **系統穩定性**：批量操作不影響系統整體效能
- **維護性**：程式碼結構清晰，易於後續維護和擴展

## 8. 實作細節

### 8.1 工具基本資訊

- **工具名稱**：`importMenuItemToOnlineRestaurant`
- **描述**：批量匯入 iChef 菜單商品到外帶外送平台的指定分類
- **分類**：`menu`
- **版本**：`1.0.0`

### 8.2 輸入參數 Schema

```typescript
interface ImportMenuItemArgs {
  categoryUuid: string; // 外送分類 UUID（必填）
  ichefMenuItemUuids: string[]; // iChef 商品 UUID 陣列（必填）
}
```

### 8.3 輸入驗證規則

- **categoryUuid**：必須為有效的 UUID 格式
- **ichefMenuItemUuids**：必須為非空陣列，每個元素為有效的 UUID 格式

### 8.4 處理流程

1. **參數驗證**：檢查 UUID 格式和陣列有效性
2. **商品狀態檢查**：查詢每個商品的啟用狀態
3. **重複商品檢測**：檢查商品是否已存在於目標分類
4. **確認清單生成**：產生即將匯入的商品清單
5. **使用者確認**：等待使用者確認操作
6. **批量匯入執行**：呼叫 GraphQL mutation
7. **結果統計**：生成詳細的執行結果報告

### 8.5 回應格式範例

#### 確認階段回應

```
📋 即將匯入以下商品到外送分類：

┌─────────────────────────────────────────┬─────────┬──────┬────────┐
│ 商品名稱                                 │ UUID    │ 價格  │ 狀態    │
├─────────────────────────────────────────┼─────────┼──────┼────────┤
│ 招牌牛肉麵                               │ abc-123 │ $180 │ ✅ 啟用 │
│ 紅燒排骨飯                               │ def-456 │ $150 │ ✅ 啟用 │
└─────────────────────────────────────────┴─────────┴──────┴────────┘

⚠️ 以下商品因停用狀態將被跳過：
- 季節限定湯品 (ghi-789)

請確認是否繼續執行匯入操作？
```

#### 執行結果回應

```
✅ 商品匯入完成！

📊 執行結果統計：
┌──────────────┬────────┐
│ 處理狀態      │ 數量    │
├──────────────┼────────┤
│ ✅ 成功匯入   │ 2      │
│ ⚠️ 跳過重複   │ 0      │
│ ❌ 停用排除   │ 1      │
│ 📝 總計處理   │ 3      │
└──────────────┴────────┘

🎯 外送分類 UUID: {categoryUuid}
⏰ 匯入時間: {timestamp}
```

## 9. 開放問題

- [ ] 是否需要記錄匯入操作的日誌以供後續追蹤？
- [ ] 當外送分類不存在時，是否需要提供更詳細的錯誤訊息和建議？
- [ ] 是否需要提供批量匯入的 API 限制（如單次最大商品數量）以避免效能問題？
- [ ] 匯入後是否需要自動檢查商品在外送平台的顯示狀態？

---

**文件版本**：1.0  
**建立日期**：2024年12月  
**最後更新**：2024年12月  
**負責人**：開發團隊
